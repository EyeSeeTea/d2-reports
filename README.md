## Introduction

_d2-reports_ than can be used as an standalone DHIS2 webapp or an standard HTML report (App: Reports). DHIS2 versions tested: 2.34.

## Reports

### NHWA Comments

This report shows data values for data sets `NHWA Module ...`. There are two kinds of data values displayed in the report table:

1. Data values that have comments.
2. Data values related pairs (value/comment), which are rendered as a single row. The pairing criteria is:

    - Comment data element `NHWA_Comment of Abc`.
    - Value data element: `NHWA_Abc`.

The API endpoint `/dataValueSets` does not provide all the features we need, so we use a custom SQL View instead.

## Initial setup

```
$ nvm use # Install node from .nvmrc
$ yarn install
```

## Development

Start the development server at `http://localhost:8082` using `https://play.dhis2.org/2.34` as a backend:

```
$ PORT=8082 REACT_APP_DHIS2_BASE_URL="https://play.dhis2.org/2.34" yarn start
```

## Deploy

Create an standard report:

```
$ yarn build-report # Creates dist/index.html
$ yarn build-<key>-metadata -u 'user:pass' --url http://dhis2-server.org # Creates dist/metadata.json (key is a particular report group, e.g. nhwa)
$ yarn post-<key>-metadata -u 'user:pass' --url http://dhis2-server.org # Posts dist/metadata.json (key is a particular report group, e.g. nhwa)
```

Create an standalone DHIS2 webapp app:

```
$ yarn build-webapp # Creates dist/d2-reports.zip
```

### Autogenerated data forms

#### Metadata

Expected structure of the metadata:

-   _Data set_ -> _Edit_: Add all the data elements that need to be displayed.
-   _Data set_ -> _Manage sections_: Create a section for each table to display in the form.

##### View mode: table

Data elements will be shown in the first column.

##### View mode: grid

Data elements will by grouped by rows and columns from data elements **formName** or **name**,
using `" - "` as a separator.

An example, a section: `ITNs` with data elements:

    -   `ITNs - Basic - Written Policy`
    -   `ITNs - Basic - Policy Implemented`
    -   `ITNs - Extended - Written Policy`
    -   `ITNs - Extended - Policy Implemented`

This will create this table:

```
    ITNs            | Written Policy | Policy Implemented |
    ITNs - Basic    |  [         ]   |    [           ]   |
    ITNs - Extended |  [         ]   |    [           ]   |
```

#### Data store customization

Data sets, data set sections and data elements are customitzable using the global data Store:

http://localhost:8080/dhis-web-datastore/index.html#/edit/d2-reports/autogenerated-forms

An example:

```json
{
    "dataElements": [
        {
            "code": "MAL_PROF_MEDICINE_1ST_LINE_TRT_OF_UNCONF",
            "selection": {
                "isMultiple": true,
                "optionSet": {
                    "code": "MAL_OS_ANTI_MAL_PF"
                }
            }
        }
    ],

    "dataSets": [
        {
            "code": "DATASET1",
            "texts": {
                "header": "<h2>Header from dataStore</h2>",
                "footer": "<i>Footer from dataStore</i>"
            },
            "viewType": "grid"
        },
        {
            "code": "DATASET2",
            "viewType": "grid",
            "sections": [
                {
                    "code": "PREVENTION_CONTACT_INFO",
                    "viewType": "table"
                }
            ]
        }
    ]
}
```

#### Development

On development, you need to specify the orgUnit/dataSet/period:

http://localhost:8081?orgUnit=ID&dataSet=ID&period=PERIOD

#### Deploy

```
$ yarn build-autogenerated-forms
```

This task creates `dist/custom-data-form.html`, which can be directly pasted as a DHIS2 data
set custom form (_Maintenance_ -> _Data set_ -> Right-click on data set -> _Design
data entry form_ -> _{Source code}_ -> Paste HTML -> _{Save}_).
